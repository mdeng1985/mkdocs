<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Mdeng li"><link href=https://mdeng1985.github.io/mkdocs/ROS/7-ROS%20Live%20Class/54-ROS%20Control%20Intro%20Build%20your%20own%20controller/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-7.1.1"><title>54 ROS Control Intro Build your own controller - Mdeng Li's Blog</title><link rel=stylesheet href=../../../assets/stylesheets/main.9299cb39.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.ef6f36e2.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=manifest href=../../../manifest.webmanifest crossorigin=use-credentials><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","None","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=none data-md-color-accent=none> <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#54-ros-control-intro-build-your-own-controller class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="Mdeng Li's Blog" class="md-header__button md-logo" aria-label="Mdeng Li's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Mdeng Li's Blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 54 ROS Control Intro Build your own controller </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/mdeng1985/mkdocs title="前往 GitHub 仓库" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> mkdocs </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Mdeng Li's Blog" class="md-nav__button md-logo" aria-label="Mdeng Li's Blog" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> Mdeng Li's Blog </label> <div class=md-nav__source> <a href=https://github.com/mdeng1985/mkdocs title="前往 GitHub 仓库" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> mkdocs </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> 首页 </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> ROS <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=ROS data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> ROS </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1 type=checkbox id=__nav_2_1> <label class=md-nav__link for=__nav_2_1> 0 ROS基本操作 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="0 ROS基本操作" data-md-level=2> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 0 ROS基本操作 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../0-ROS%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/0-ROS%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85/ class=md-nav__link> 0 ROS系统安装 </a> </li> <li class=md-nav__item> <a href=../../0-ROS%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/1-%20ROS%E7%A9%BA%E9%97%B4/ class=md-nav__link> 1 ROS空间 </a> </li> <li class=md-nav__item> <a href=../../0-ROS%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/2-ROS%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ class=md-nav__link> 2 ROS基础知识 </a> </li> <li class=md-nav__item> <a href=../../0-ROS%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/3-ROS%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/ class=md-nav__link> 3 ROS常用命令 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2> 1 实践demo <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="1 实践demo" data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 1 实践demo </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../1-%E5%AE%9E%E8%B7%B5demo/0-turtlesim%20package%E5%AE%9E%E8%B7%B5/ class=md-nav__link> 0 turtlesim package实践 </a> </li> <li class=md-nav__item> <a href=../../1-%E5%AE%9E%E8%B7%B5demo/1-hello%E5%8A%9F%E8%83%BD%E5%8C%85/ class=md-nav__link> 1 hello功能包 </a> </li> <li class=md-nav__item> <a href=../../1-%E5%AE%9E%E8%B7%B5demo/2-%E5%8F%91%E5%B8%83%E5%92%8C%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF/ class=md-nav__link> 2 发布和订阅消息 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3> 5 gazebo <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="5 gazebo" data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 5 gazebo </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../5-gazebo/0-gazebo_ros_pkgs%E5%AE%89%E8%A3%85/ class=md-nav__link> 0 gazebo ros pkgs安装 </a> </li> <li class=md-nav__item> <a href=../../5-gazebo/0-gazebo%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ class=md-nav__link> 0 gazebo基础知识 </a> </li> <li class=md-nav__item> <a href=../../5-gazebo/0-gazebo%E9%87%8C%E7%9A%84world/ class=md-nav__link> 0 gazebo里的world </a> </li> <li class=md-nav__item> <a href=../../5-gazebo/2-gazebo%20tutorial%202%E4%B9%8BRRBot%E6%80%BB%E7%BB%93/ class=md-nav__link> 2 gazebo tutorial 2之RRBot总结 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4> 6 gazebo 官方tutorials <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="6 gazebo 官方tutorials" data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 6 gazebo 官方tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4_1 type=checkbox id=__nav_2_4_1> <label class=md-nav__link for=__nav_2_4_1> Connect to ROS <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Connect to ROS" data-md-level=3> <label class=md-nav__title for=__nav_2_4_1> <span class="md-nav__icon md-icon"></span> Connect to ROS </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../6-gazebo%20%E5%AE%98%E6%96%B9tutorials/Connect%20to%20ROS/0-Tutorial%20Using%20roslaunch%20to%20start%20Gazebo%2C%20world%20files%20and%20URDF%20models/ class=md-nav__link> 0 Tutorial Using roslaunch to start Gazebo, world files and URDF models </a> </li> <li class=md-nav__item> <a href=../../6-gazebo%20%E5%AE%98%E6%96%B9tutorials/Connect%20to%20ROS/1-Tutorial%20Using%20a%20URDF%20in%20Gazebo/ class=md-nav__link> 1 Tutorial Using a URDF in Gazebo </a> </li> <li class=md-nav__item> <a href=../../6-gazebo%20%E5%AE%98%E6%96%B9tutorials/Connect%20to%20ROS/2-Tutorial%20Using%20Gazebo%20plugins%20with%20ROS/ class=md-nav__link> 2 Tutorial Using Gazebo plugins with ROS </a> </li> <li class=md-nav__item> <a href=../../6-gazebo%20%E5%AE%98%E6%96%B9tutorials/Connect%20to%20ROS/3-Tutorial%20ROS%20Control/ class=md-nav__link> 3 Tutorial ROS Control </a> </li> <li class=md-nav__item> <a href=../../6-gazebo%20%E5%AE%98%E6%96%B9tutorials/Connect%20to%20ROS/4-Tutorial%20ROS%20Communication/ class=md-nav__link> 4 Tutorial ROS Communication </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_5 type=checkbox id=__nav_2_5 checked> <label class=md-nav__link for=__nav_2_5> 7 ROS Live Class <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="7 ROS Live Class" data-md-level=2> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 7 ROS Live Class </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 54 ROS Control Intro Build your own controller <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> 54 ROS Control Intro Build your own controller </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#why-this-class class=md-nav__link> Why this class? </a> </li> <li class=md-nav__item> <a href=#simulation-to-be-used-today class=md-nav__link> Simulation to be used today </a> <nav class=md-nav aria-label="Simulation to be used today"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#how-to-use-this-rosject class=md-nav__link> How to use this ROSject </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0-requirements-for-the-controller class=md-nav__link> 0. Requirements for the controller </a> </li> <li class=md-nav__item> <a href=#1-creating-the-package class=md-nav__link> 1. Creating the package </a> </li> <li class=md-nav__item> <a href=#2-creating-the-source-code-of-the-controller class=md-nav__link> 2. Creating the source code of the controller </a> <nav class=md-nav aria-label="2. Creating the source code of the controller"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#add-the-required-include-files class=md-nav__link> Add the required include files </a> </li> <li class=md-nav__item> <a href=#add-a-name-space-for-our-controller class=md-nav__link> Add a name space for our controller </a> </li> <li class=md-nav__item> <a href=#create-the-class-of-the-controller class=md-nav__link> Create the class of the controller </a> </li> <li class=md-nav__item> <a href=#initialize-the-controller class=md-nav__link> Initialize the controller </a> </li> <li class=md-nav__item> <a href=#create-the-update-loop class=md-nav__link> Create the update loop </a> </li> <li class=md-nav__item> <a href=#add-the-start-and-stop-functions class=md-nav__link> Add the start and stop functions </a> </li> <li class=md-nav__item> <a href=#add-some-required-class-members class=md-nav__link> Add some required class members </a> </li> <li class=md-nav__item> <a href=#register-this-library-as-a-controller-available class=md-nav__link> Register this library as a controller available </a> </li> <li class=md-nav__item> <a href=#the-full-controller-code class=md-nav__link> The full controller code </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-compiling-the-controller class=md-nav__link> 3. Compiling the controller </a> <nav class=md-nav aria-label="3. Compiling the controller"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-a-plugin-description-file class=md-nav__link> Create a plugin description file </a> </li> <li class=md-nav__item> <a href=#update-the-packagexml-file class=md-nav__link> Update the package.xml file </a> </li> <li class=md-nav__item> <a href=#update-the-cmakeliststxt-file class=md-nav__link> Update the CMakeLists.txt file </a> </li> <li class=md-nav__item> <a href=#build-the-controller class=md-nav__link> Build the controller </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-launching-the-controller class=md-nav__link> 4. Launching the controller </a> <nav class=md-nav aria-label="4. Launching the controller"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#modify-the-configuration-file class=md-nav__link> Modify the configuration file </a> </li> <li class=md-nav__item> <a href=#lets-launch-it class=md-nav__link> Let's launch it! </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../55-Understanding%20the%20differences%20between%20robot_state_publisher%20and%20joint_state_publisher/ class=md-nav__link> 55 Understanding the differences between robot state publisher and joint state publisher </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Markdown <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Markdown data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Markdown </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../markdown/markdown%E8%AF%AD%E6%B3%95/ class=md-nav__link> markdown语法 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2> Examples <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Examples data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../markdown/examples/ class=md-nav__link> Insiders </a> </li> <li class=md-nav__item> <a href=../../../markdown/examples/abbreviations/ class=md-nav__link> Abbreviations </a> </li> <li class=md-nav__item> <a href=../../../markdown/examples/changing-the-colors/ class=md-nav__link> Changing the colors </a> </li> <li class=md-nav__item> <a href=../../../markdown/examples/getting-started/ class=md-nav__link> Getting started </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Mkdocs <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Mkdocs data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Mkdocs </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../mkdocs/MkDocs%E7%AC%94%E8%AE%B0/ class=md-nav__link> MkDocs笔记 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5> 钢琴 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=钢琴 data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> 钢琴 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../%E9%92%A2%E7%90%B4/0-%E9%92%A2%E7%90%B4%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86/ class=md-nav__link> 0 钢琴基本知识 </a> </li> <li class=md-nav__item> <a href=../../../%E9%92%A2%E7%90%B4/1-%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%8C%87%E6%B3%95/ class=md-nav__link> 1 一些基本指法 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#why-this-class class=md-nav__link> Why this class? </a> </li> <li class=md-nav__item> <a href=#simulation-to-be-used-today class=md-nav__link> Simulation to be used today </a> <nav class=md-nav aria-label="Simulation to be used today"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#how-to-use-this-rosject class=md-nav__link> How to use this ROSject </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#0-requirements-for-the-controller class=md-nav__link> 0. Requirements for the controller </a> </li> <li class=md-nav__item> <a href=#1-creating-the-package class=md-nav__link> 1. Creating the package </a> </li> <li class=md-nav__item> <a href=#2-creating-the-source-code-of-the-controller class=md-nav__link> 2. Creating the source code of the controller </a> <nav class=md-nav aria-label="2. Creating the source code of the controller"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#add-the-required-include-files class=md-nav__link> Add the required include files </a> </li> <li class=md-nav__item> <a href=#add-a-name-space-for-our-controller class=md-nav__link> Add a name space for our controller </a> </li> <li class=md-nav__item> <a href=#create-the-class-of-the-controller class=md-nav__link> Create the class of the controller </a> </li> <li class=md-nav__item> <a href=#initialize-the-controller class=md-nav__link> Initialize the controller </a> </li> <li class=md-nav__item> <a href=#create-the-update-loop class=md-nav__link> Create the update loop </a> </li> <li class=md-nav__item> <a href=#add-the-start-and-stop-functions class=md-nav__link> Add the start and stop functions </a> </li> <li class=md-nav__item> <a href=#add-some-required-class-members class=md-nav__link> Add some required class members </a> </li> <li class=md-nav__item> <a href=#register-this-library-as-a-controller-available class=md-nav__link> Register this library as a controller available </a> </li> <li class=md-nav__item> <a href=#the-full-controller-code class=md-nav__link> The full controller code </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-compiling-the-controller class=md-nav__link> 3. Compiling the controller </a> <nav class=md-nav aria-label="3. Compiling the controller"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-a-plugin-description-file class=md-nav__link> Create a plugin description file </a> </li> <li class=md-nav__item> <a href=#update-the-packagexml-file class=md-nav__link> Update the package.xml file </a> </li> <li class=md-nav__item> <a href=#update-the-cmakeliststxt-file class=md-nav__link> Update the CMakeLists.txt file </a> </li> <li class=md-nav__item> <a href=#build-the-controller class=md-nav__link> Build the controller </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-launching-the-controller class=md-nav__link> 4. Launching the controller </a> <nav class=md-nav aria-label="4. Launching the controller"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#modify-the-configuration-file class=md-nav__link> Modify the configuration file </a> </li> <li class=md-nav__item> <a href=#lets-launch-it class=md-nav__link> Let's launch it! </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=54-ros-control-intro-build-your-own-controller>54： ROS Control Intro: Build your own controller<a class=headerlink href=#54-ros-control-intro-build-your-own-controller title="Permanent link">&para;</a></h1> <p><a href=https://app.theconstructsim.com/en/signup/#/LiveClasses>课程网址</a></p> <p>This notebook is additional material for the <strong>ROS Developers Live Class n.54</strong> created and provided for free by <strong>Alberto Ezquerro</strong> and <strong>Ricardo Tellez</strong> of <a href=www.theconstructsim.com>The Construct</a>. You can distribute this notebook as long as you provide copy of this paragraph with it.</p> <h2 id=why-this-class>Why this class?<a class=headerlink href=#why-this-class title="Permanent link">&para;</a></h2> <p>Up to this point, you are using the default controllers that the ros_control packages provide, which is the most common practice. In some cases, it may be interesting to create a custom ROS controller that sends specific commands to your joints.</p> <p>In today's live class, we are going to learn the following contents: 1. <strong>How to create a ROS Controller for joints</strong> 2. <strong>How to use it in your robot</strong></p> <p>Pre-requisites for this live class are: * Basic knowledge of <b>ROS concepts such as topics, publish and subscribe, ROS Service</b> using <strong>C++</strong>. If you don't know about it, <a href=http://www.theconstructsim.com/construct-learn-develop-robots-using-ros/robotigniteacademy_learnros/ros-courses-library/ros-courses-ros-basics-in-5-days-c/ >check this course</a> * Knowledge of C++ * Knowledge of <b>URDF format for robot definition</b>. If you don't know about it, <a href=http://www.theconstructsim.com/construct-learn-develop-robots-using-ros/robotigniteacademy_learnros/ros-courses-library/robot-creation-with-urdf/ >check this course</a>. * Love for Robotics * ...that's it!!</p> <h2 id=simulation-to-be-used-today>Simulation to be used today<a class=headerlink href=#simulation-to-be-used-today title="Permanent link">&para;</a></h2> <p>We are going to use the Pi Robot simulation</p> <p><img alt=img src=https://i.loli.net/2021/04/24/rUVBdzNew52aIjK.png></p> <h3 id=how-to-use-this-rosject>How to use this ROSject<a class=headerlink href=#how-to-use-this-rosject title="Permanent link">&para;</a></h3> <p>A <a href=http://rosjects.com><strong>ROSject</strong></a> is a <strong>ROS project</strong> packaged in such a way that all the material it contains (<strong>ROS code, Gazebo simulations and Notebooks</strong>) can be shared with any body <strong>using only a web link</strong>. That is what we did with all the attendants to the Live Class, we shared this ROSject with them (so they can have access to all the ROS material they contain).</p> <p><strong>Check <a heref="https://www.youtube.com/watch?v=cR-Ow5K7oSo">this webinar</a> to learn more about ROSjects and how to create your own ROSjects</strong>.</p> <p>You will need to have a free account at the <a href=http://rosds.online>ROS Development Studio</a> (ROSDS). Get the account and then follow the indications below.</p> <h2 id=0-requirements-for-the-controller>0. Requirements for the controller<a class=headerlink href=#0-requirements-for-the-controller title="Permanent link">&para;</a></h2> <ul> <li>It will be a controller to control effort based joints</li> <li>It is going to accept position values</li> <li>It is going to be called <strong>MyPositionController</strong></li> </ul> <h2 id=1-creating-the-package>1. Creating the package<a class=headerlink href=#1-creating-the-package title="Permanent link">&para;</a></h2> <p>Create a new package named my_controller with the following dependencies: <i><b>roscpp</b></i>, <i><b>pluginlib</b></i>, <i><b>controller_interface</b></i>, and <i><b>hardware_interface</b></i>. To do that, just execute the following command:</p> <div class=highlight><pre><span></span><code><span class=err>$</span> <span class=n>cd</span> <span class=o>~/</span><span class=n>catkin_ws</span><span class=o>/</span><span class=n>src</span>
<span class=err>$</span> <span class=n>catkin_create_pkg</span> <span class=n>my_controller</span> <span class=n>roscpp</span> <span class=n>pluginlib</span> <span class=n>controller_interface</span> <span class=n>hardware_interface</span>
</code></pre></div> <p><img alt=img src=https://i.loli.net/2021/04/24/Cg6p3bExXcMJqTS.png></p> <h2 id=2-creating-the-source-code-of-the-controller>2. Creating the source code of the controller<a class=headerlink href=#2-creating-the-source-code-of-the-controller title="Permanent link">&para;</a></h2> <p>Inside the src folder that was created in your new package, create a file named <i><b>my_controller.cpp</b></i>. Let's populate it!</p> <h4 id=add-the-required-include-files>Add the required include files<a class=headerlink href=#add-the-required-include-files title="Permanent link">&para;</a></h4> <p>Include the libraries that allow us to define a new controller, a new hardware interface and a new plugin</p> <div class=highlight><pre><span></span><code><span class=c1>#include &lt;controller_interface/controller.h&gt;</span>
<span class=c1>#include &lt;hardware_interface/joint_command_interface.h&gt;</span>
<span class=c1>#include &lt;pluginlib/class_list_macros.h&gt;</span>
<span class=c1>#include &lt;std_msgs/Float64.h&gt;</span>
</code></pre></div> <h4 id=add-a-name-space-for-our-controller>Add a name space for our controller<a class=headerlink href=#add-a-name-space-for-our-controller title="Permanent link">&para;</a></h4> <p>This namespace allow us to differentiate controllers that have the same name, but different implementation (so we do not confuse ourselves):</p> <div class=highlight><pre><span></span><code><span class=n>namespace</span> <span class=n>my_controller_ns</span>
<span class=p>{</span>


<span class=p>}</span>
</code></pre></div> <h4 id=create-the-class-of-the-controller>Create the class of the controller<a class=headerlink href=#create-the-class-of-the-controller title="Permanent link">&para;</a></h4> <p>Since we are creating an effort controller we are going to create our controller inheriting from the hardware interface <strong>EffortJointInterface</strong>. This means that our controller has to follow that interface in order to be able to properly communicate with an effort joint in the hardware.</p> <div class=highlight><pre><span></span><code><span class=k>class</span> <span class=nc>MyPositionController</span> <span class=p>:</span> <span class=n>public</span> <span class=n>controller_interface</span><span class=p>::</span><span class=n>Controller</span><span class=o>&lt;</span><span class=n>hardware_interface</span><span class=p>::</span><span class=n>EffortJointInterface</span><span class=o>&gt;</span>
<span class=p>{</span>

<span class=p>};</span>
</code></pre></div> <h4 id=initialize-the-controller>Initialize the controller<a class=headerlink href=#initialize-the-controller title="Permanent link">&para;</a></h4> <p>The <em>init()</em> function is called when your controller is loaded by the <em>controller manager</em>. Inside this function, you must:</p> <ul> <li>get the <strong>name of the joint</strong> that you will control from the Parameter Server first (so from the YAML file, which you will modify later)</li> <li>get the actual <strong>joint object</strong> that provides access to the resources of the joint. We will use that object in the <strong>realtime loop</strong>.</li> <li>get the value of the <strong>gain</strong> parameter</li> <li>start the subscriber for receiving <strong>desired joint positions</strong></li> </ul> <div class=highlight><pre><span></span><code>        <span class=nb>bool</span> <span class=n>init</span><span class=p>(</span><span class=n>hardware_interface</span><span class=p>::</span><span class=n>EffortJointInterface</span><span class=o>*</span> <span class=n>hw</span><span class=p>,</span> <span class=n>ros</span><span class=p>::</span><span class=n>NodeHandle</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>std</span><span class=p>::</span><span class=n>string</span> <span class=n>my_joint</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=err>!</span><span class=n>n</span><span class=o>.</span><span class=n>getParam</span><span class=p>(</span><span class=s2>&quot;joint&quot;</span><span class=p>,</span> <span class=n>my_joint</span><span class=p>))</span>
            <span class=p>{</span>
                <span class=n>ROS_ERROR</span><span class=p>(</span><span class=s2>&quot;Could not find joint name&quot;</span><span class=p>);</span>
                <span class=k>return</span> <span class=n>false</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>joint_</span> <span class=o>=</span> <span class=n>hw</span><span class=o>-&gt;</span><span class=n>getHandle</span><span class=p>(</span><span class=n>my_joint</span><span class=p>);</span>  <span class=o>//</span> <span class=n>throws</span> <span class=n>on</span> <span class=n>failure</span>
            <span class=n>command_</span> <span class=o>=</span> <span class=n>joint_</span><span class=o>.</span><span class=n>getPosition</span><span class=p>();</span>   <span class=o>//</span> <span class=nb>set</span> <span class=n>the</span> <span class=n>current</span> <span class=n>joint</span> <span class=n>goal</span> <span class=n>to</span> <span class=n>the</span> <span class=n>current</span> <span class=n>joint</span> <span class=n>position</span>

            <span class=o>//</span> <span class=n>Load</span> <span class=n>gain</span> <span class=n>using</span> <span class=n>gains</span> <span class=nb>set</span> <span class=n>on</span> <span class=n>parameter</span> <span class=n>server</span>
            <span class=k>if</span> <span class=p>(</span><span class=err>!</span><span class=n>n</span><span class=o>.</span><span class=n>getParam</span><span class=p>(</span><span class=s2>&quot;gain&quot;</span><span class=p>,</span> <span class=n>gain_</span><span class=p>))</span>
            <span class=p>{</span>
                <span class=n>ROS_ERROR</span><span class=p>(</span><span class=s2>&quot;Could not find the gain parameter value&quot;</span><span class=p>);</span>
                <span class=k>return</span> <span class=n>false</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=o>//</span> <span class=n>Start</span> <span class=n>command</span> <span class=n>subscriber</span>
            <span class=n>sub_command_</span> <span class=o>=</span> <span class=n>n</span><span class=o>.</span><span class=n>subscribe</span><span class=o>&lt;</span><span class=n>std_msgs</span><span class=p>::</span><span class=n>Float64</span><span class=o>&gt;</span><span class=p>(</span><span class=s2>&quot;command&quot;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>MyPositionController</span><span class=p>::</span><span class=n>setCommandCB</span><span class=p>,</span> <span class=n>this</span><span class=p>);</span>

            <span class=k>return</span> <span class=n>true</span><span class=p>;</span>
        <span class=p>}</span>
</code></pre></div> <h4 id=create-the-update-loop>Create the <em>update</em> loop<a class=headerlink href=#create-the-update-loop title="Permanent link">&para;</a></h4> <p>The update loop is <strong>the control loop that is going to be executed by the controller</strong>. It is here where you put your controller code.</p> <p>Here you are defining the command that you are going to send to your joint. In this case, it's a product between an * <strong>error</strong> * variable and a * <strong>gain_</strong> * variable. The error variable is defined as the difference between the current position (* <strong>joint_.getPosition()</strong> <em>) of the joint and the goal position (</em> <strong>setpoint_</strong> *) of the joint.</p> <p>In this example we have put a very simple controller. You can create the controller as complex as possible, but remember not to put too much computation to prevent to break the controller loop time.</p> <div class=highlight><pre><span></span><code>        <span class=n>void</span> <span class=n>update</span><span class=p>(</span><span class=n>const</span> <span class=n>ros</span><span class=p>::</span><span class=n>Time</span><span class=o>&amp;</span> <span class=n>time</span><span class=p>,</span> <span class=n>const</span> <span class=n>ros</span><span class=p>::</span><span class=n>Duration</span><span class=o>&amp;</span> <span class=n>period</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>double</span> <span class=n>error</span> <span class=o>=</span> <span class=n>command_</span> <span class=o>-</span> <span class=n>joint_</span><span class=o>.</span><span class=n>getPosition</span><span class=p>();</span>
            <span class=n>double</span> <span class=n>commanded_effort</span> <span class=o>=</span> <span class=n>error</span><span class=o>*</span><span class=n>gain_</span><span class=p>;</span>
            <span class=n>joint_</span><span class=o>.</span><span class=n>setCommand</span><span class=p>(</span><span class=n>commanded_effort</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=n>void</span> <span class=n>setCommandCB</span><span class=p>(</span><span class=n>const</span> <span class=n>std_msgs</span><span class=p>::</span><span class=n>Float64ConstPtr</span><span class=o>&amp;</span> <span class=n>msg</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>command_</span> <span class=o>=</span> <span class=n>msg</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
        <span class=p>}</span>
</code></pre></div> <h4 id=add-the-start-and-stop-functions>Add the <em>start</em> and <em>stop</em> functions<a class=headerlink href=#add-the-start-and-stop-functions title="Permanent link">&para;</a></h4> <p>You need to add two functions that will be executed during the start and stop of the controller by the controller manager. </p> <p>Put in those the content you want to be done for <strong>initialization of the controller</strong> and for <strong>stopping of the controller</strong>.</p> <div class=highlight><pre><span></span><code><span class=n>void</span> <span class=n>starting</span><span class=p>(</span><span class=n>const</span> <span class=n>ros</span><span class=p>::</span><span class=n>Time</span><span class=o>&amp;</span> <span class=n>time</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>
<span class=n>void</span> <span class=n>stopping</span><span class=p>(</span><span class=n>const</span> <span class=n>ros</span><span class=p>::</span><span class=n>Time</span><span class=o>&amp;</span> <span class=n>time</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>
</code></pre></div> <h4 id=add-some-required-class-members>Add some required class members<a class=headerlink href=#add-some-required-class-members title="Permanent link">&para;</a></h4> <p>Those are required to make the class work</p> <div class=highlight><pre><span></span><code>        <span class=n>private</span><span class=p>:</span>
            <span class=n>hardware_interface</span><span class=p>::</span><span class=n>JointHandle</span> <span class=n>joint_</span><span class=p>;</span>
            <span class=n>double</span> <span class=n>gain_</span><span class=p>;</span>
            <span class=n>double</span> <span class=n>command_</span><span class=p>;</span>
            <span class=n>ros</span><span class=p>::</span><span class=n>Subscriber</span> <span class=n>sub_command_</span><span class=p>;</span>
</code></pre></div> <h4 id=register-this-library-as-a-controller-available>Register this library as a controller available<a class=headerlink href=#register-this-library-as-a-controller-available title="Permanent link">&para;</a></h4> <p>Here, you are calling the special macro plugin <i><b>PLUGINLIB_EXPORT_CLASS</b></i> in order to allow this class to be dynamically loaded.</p> <div class=highlight><pre><span></span><code><span class=n>PLUGINLIB_EXPORT_CLASS</span><span class=p>(</span><span class=n>my_controller_ns</span><span class=p>::</span><span class=n>MyPositionController</span><span class=p>,</span> <span class=n>controller_interface</span><span class=p>::</span><span class=n>ControllerBase</span><span class=p>);</span>
</code></pre></div> <p>More info about how the pluginlib works, <a href=http://wiki.ros.org/pluginlib>here</a>.</p> <h4 id=the-full-controller-code>The full controller code<a class=headerlink href=#the-full-controller-code title="Permanent link">&para;</a></h4> <p>At the end, the code of your controller should look like this: </p> <div class=highlight><pre><span></span><code><span class=c1>#include &lt;controller_interface/controller.h&gt;</span>
<span class=c1>#include &lt;hardware_interface/joint_command_interface.h&gt;</span>
<span class=c1>#include &lt;pluginlib/class_list_macros.h&gt;</span>
<span class=c1>#include &lt;std_msgs/Float64.h&gt;</span>

<span class=n>namespace</span> <span class=n>my_controller_ns</span>
<span class=p>{</span>
    <span class=k>class</span> <span class=nc>MyPositionController</span> <span class=p>:</span> <span class=n>public</span> <span class=n>controller_interface</span><span class=p>::</span><span class=n>Controller</span><span class=o>&lt;</span><span class=n>hardware_interface</span><span class=p>::</span><span class=n>EffortJointInterface</span><span class=o>&gt;</span>
    <span class=p>{</span>

        <span class=nb>bool</span> <span class=n>init</span><span class=p>(</span><span class=n>hardware_interface</span><span class=p>::</span><span class=n>EffortJointInterface</span><span class=o>*</span> <span class=n>hw</span><span class=p>,</span> <span class=n>ros</span><span class=p>::</span><span class=n>NodeHandle</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>std</span><span class=p>::</span><span class=n>string</span> <span class=n>my_joint</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=err>!</span><span class=n>n</span><span class=o>.</span><span class=n>getParam</span><span class=p>(</span><span class=s2>&quot;joint&quot;</span><span class=p>,</span> <span class=n>my_joint</span><span class=p>))</span>
            <span class=p>{</span>
                <span class=n>ROS_ERROR</span><span class=p>(</span><span class=s2>&quot;Could not find joint name&quot;</span><span class=p>);</span>
                <span class=k>return</span> <span class=n>false</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>joint_</span> <span class=o>=</span> <span class=n>hw</span><span class=o>-&gt;</span><span class=n>getHandle</span><span class=p>(</span><span class=n>my_joint</span><span class=p>);</span>  <span class=o>//</span> <span class=n>throws</span> <span class=n>on</span> <span class=n>failure</span>
            <span class=n>command_</span> <span class=o>=</span> <span class=n>joint_</span><span class=o>.</span><span class=n>getPosition</span><span class=p>();</span>

            <span class=o>//</span> <span class=n>Load</span> <span class=n>gain</span> <span class=n>using</span> <span class=n>gains</span> <span class=nb>set</span> <span class=n>on</span> <span class=n>parameter</span> <span class=n>server</span>
            <span class=k>if</span> <span class=p>(</span><span class=err>!</span><span class=n>n</span><span class=o>.</span><span class=n>getParam</span><span class=p>(</span><span class=s2>&quot;gain&quot;</span><span class=p>,</span> <span class=n>gain_</span><span class=p>))</span>
            <span class=p>{</span>
                <span class=n>ROS_ERROR</span><span class=p>(</span><span class=s2>&quot;Could not find the gain parameter value&quot;</span><span class=p>);</span>
                <span class=k>return</span> <span class=n>false</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=o>//</span> <span class=n>Start</span> <span class=n>command</span> <span class=n>subscriber</span>
            <span class=n>sub_command_</span> <span class=o>=</span> <span class=n>n</span><span class=o>.</span><span class=n>subscribe</span><span class=o>&lt;</span><span class=n>std_msgs</span><span class=p>::</span><span class=n>Float64</span><span class=o>&gt;</span><span class=p>(</span><span class=s2>&quot;command&quot;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>MyPositionController</span><span class=p>::</span><span class=n>setCommandCB</span><span class=p>,</span> <span class=n>this</span><span class=p>);</span>

            <span class=k>return</span> <span class=n>true</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=n>void</span> <span class=n>update</span><span class=p>(</span><span class=n>const</span> <span class=n>ros</span><span class=p>::</span><span class=n>Time</span><span class=o>&amp;</span> <span class=n>time</span><span class=p>,</span> <span class=n>const</span> <span class=n>ros</span><span class=p>::</span><span class=n>Duration</span><span class=o>&amp;</span> <span class=n>period</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>double</span> <span class=n>error</span> <span class=o>=</span> <span class=n>command_</span> <span class=o>-</span> <span class=n>joint_</span><span class=o>.</span><span class=n>getPosition</span><span class=p>();</span>
            <span class=n>double</span> <span class=n>commanded_effort</span> <span class=o>=</span> <span class=n>error</span><span class=o>*</span><span class=n>gain_</span><span class=p>;</span>
            <span class=n>joint_</span><span class=o>.</span><span class=n>setCommand</span><span class=p>(</span><span class=n>commanded_effort</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=n>void</span> <span class=n>setCommandCB</span><span class=p>(</span><span class=n>const</span> <span class=n>std_msgs</span><span class=p>::</span><span class=n>Float64ConstPtr</span><span class=o>&amp;</span> <span class=n>msg</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>command_</span> <span class=o>=</span> <span class=n>msg</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=n>void</span> <span class=n>starting</span><span class=p>(</span><span class=n>const</span> <span class=n>ros</span><span class=p>::</span><span class=n>Time</span><span class=o>&amp;</span> <span class=n>time</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>
        <span class=n>void</span> <span class=n>stopping</span><span class=p>(</span><span class=n>const</span> <span class=n>ros</span><span class=p>::</span><span class=n>Time</span><span class=o>&amp;</span> <span class=n>time</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>

        <span class=n>private</span><span class=p>:</span>
            <span class=n>hardware_interface</span><span class=p>::</span><span class=n>JointHandle</span> <span class=n>joint_</span><span class=p>;</span>
            <span class=n>double</span> <span class=n>gain_</span><span class=p>;</span>
            <span class=n>double</span> <span class=n>command_</span><span class=p>;</span>
            <span class=n>ros</span><span class=p>::</span><span class=n>Subscriber</span> <span class=n>sub_command_</span><span class=p>;</span>
    <span class=p>};</span>

    <span class=n>PLUGINLIB_EXPORT_CLASS</span><span class=p>(</span><span class=n>my_controller_ns</span><span class=p>::</span><span class=n>MyPositionController</span><span class=p>,</span> <span class=n>controller_interface</span><span class=p>::</span><span class=n>ControllerBase</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <h2 id=3-compiling-the-controller>3. Compiling the controller<a class=headerlink href=#3-compiling-the-controller title="Permanent link">&para;</a></h2> <h4 id=create-a-plugin-description-file>Create a plugin description file<a class=headerlink href=#create-a-plugin-description-file title="Permanent link">&para;</a></h4> <p>Inside your package, create a new file named <strong>controller_plugins.xml</strong>. This file is a description of the controller plugin. It indicates the path where the library will be placed when we compile the controller, as well as the name, type, and class of the controller. </p> <p>Copy the following code into it:</p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>library</span> <span class=n>path</span><span class=o>=</span><span class=s2>&quot;lib/libmy_controller_lib&quot;</span><span class=o>&gt;</span>
  <span class=o>&lt;</span><span class=k>class</span> <span class=nc>name</span><span class=o>=</span><span class=s2>&quot;my_controller/MyPositionController&quot;</span> 
         <span class=nb>type</span><span class=o>=</span><span class=s2>&quot;my_controller_ns::MyPositionController&quot;</span>           
         <span class=n>base_class_type</span><span class=o>=</span><span class=s2>&quot;controller_interface::ControllerBase&quot;</span> <span class=o>/&gt;</span>
<span class=o>&lt;/</span><span class=n>library</span><span class=o>&gt;</span>
</code></pre></div> <h4 id=update-the-packagexml-file>Update the <em>package.xml</em> file<a class=headerlink href=#update-the-packagexml-file title="Permanent link">&para;</a></h4> <p>This line indicates that our package will provide a plugin. This is very important because if we don't add this line, the controller manager won't be able to find our new controller and load it.</p> <p>Go to the <i><b>package.xml</b></i> file of your package. Inside the <i><b>&lt;export&gt;</b></i> tag, place the following line:</p> <div class=highlight><pre><span></span><code><span class=o>&lt;</span><span class=n>controller_interface</span> <span class=n>plugin</span><span class=o>=</span><span class=s2>&quot;$</span><span class=si>{prefix}</span><span class=s2>/controller_plugins.xml&quot;</span><span class=o>/&gt;</span>
</code></pre></div> <h4 id=update-the-cmakeliststxt-file>Update the <em>CMakeLists.txt</em> file<a class=headerlink href=#update-the-cmakeliststxt-file title="Permanent link">&para;</a></h4> <p>Go to the CMakeLists.txt file of your package. Find the add_library() and target_link_libraries() functions, and replace them with these:</p> <div class=highlight><pre><span></span><code><span class=n>add_library</span><span class=p>(</span><span class=n>my_controller_lib</span> <span class=n>src</span><span class=o>/</span><span class=n>my_controller</span><span class=o>.</span><span class=n>cpp</span><span class=p>)</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=n>target_link_libraries</span><span class=p>(</span><span class=n>my_controller_lib</span> <span class=err>$</span><span class=p>{</span><span class=n>catkin_LIBRARIES</span><span class=p>})</span>
</code></pre></div> <h4 id=build-the-controller>Build the controller<a class=headerlink href=#build-the-controller title="Permanent link">&para;</a></h4> <p>Go to the catkin_ws directory and compile your package</p> <div class=highlight><pre><span></span><code><span class=err>$</span> <span class=n>catkin_make</span>
</code></pre></div> <p>Check that the controller has been properly registered:</p> <div class=highlight><pre><span></span><code><span class=err>$</span> <span class=n>rospack</span> <span class=n>plugins</span> <span class=o>--</span><span class=n>attrib</span><span class=o>=</span><span class=n>plugin</span> <span class=n>controller_interface</span> <span class=o>|</span> <span class=n>grep</span> <span class=n>my_controller</span>
</code></pre></div> <p>You should get a response like this:</p> <div class=highlight><pre><span></span><code><span class=n>my_controller</span> <span class=o>/</span><span class=n>home</span><span class=o>/</span><span class=n>user</span><span class=o>/</span><span class=n>catkin_ws</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>my_controller</span><span class=o>/</span><span class=n>controller_plugins</span><span class=o>.</span><span class=n>xml</span>
</code></pre></div> <h2 id=4-launching-the-controller>4. Launching the controller<a class=headerlink href=#4-launching-the-controller title="Permanent link">&para;</a></h2> <p>Let's change the controller of the <strong>head_pan_joint</strong> to use our new controller.</p> <h4 id=modify-the-configuration-file>Modify the configuration file<a class=headerlink href=#modify-the-configuration-file title="Permanent link">&para;</a></h4> <p>Go to the controllers config file and modify the controller for the <em>head_pan_joint</em> to use our newly created one.</p> <div class=highlight><pre><span></span><code>  <span class=n>head_pan_joint_position_controller</span><span class=p>:</span>
    <span class=nb>type</span><span class=p>:</span> <span class=n>my_controller</span><span class=o>/</span><span class=n>MyPositionController</span>
    <span class=n>joint</span><span class=p>:</span> <span class=n>head_pan_joint</span>
    <span class=n>gain</span><span class=p>:</span> <span class=mf>0.1</span>
</code></pre></div> <h4 id=lets-launch-it>Let's launch it!<a class=headerlink href=#lets-launch-it title="Permanent link">&para;</a></h4> <p>Launch it by going to <strong>Simulations-&gt;Select Launch file-&gt;main.launch</strong>. You can also launch it from a shell, by calling the launch file and the opening the Gazebo window (on <strong>Tools-&gt;Gazebo</strong>).</p> <p><img alt=img src=https://i.loli.net/2021/04/24/Xlh9G5K1PoBNbyC.png></p> <p>Launch the controllers:</p> <div class=highlight><pre><span></span><code><span class=err>$</span> <span class=n>roslaunch</span> <span class=n>pi_robot_pkg</span> <span class=n>controllers</span><span class=o>.</span><span class=n>launch</span>
</code></pre></div> <p>Check that the controller has been loaded properly:</p> <div class=highlight><pre><span></span><code><span class=err>$</span> <span class=n>rosservice</span> <span class=n>call</span> <span class=o>/</span><span class=n>pi_robot</span><span class=o>/</span><span class=n>controller_manager</span><span class=o>/</span><span class=n>list_controllers</span> <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>&quot;</span>
</code></pre></div> <p>Check the the joint works properly by sending to it a goal:</p> <div class=highlight><pre><span></span><code><span class=err>$</span> <span class=n>rostopic</span> <span class=n>pub</span> <span class=o>/</span><span class=n>pi_robot</span><span class=o>/</span><span class=n>head_pan_joint_position_controller</span><span class=o>/</span><span class=n>command</span> <span class=n>std_msgs</span><span class=o>/</span><span class=n>Float64</span> <span class=s2>&quot;data: 1.0&quot;</span>
</code></pre></div> <h1 id=mission-completed>Mission completed!!<a class=headerlink href=#mission-completed title="Permanent link">&para;</a></h1> <h2 id=homework>Homework<a class=headerlink href=#homework title="Permanent link">&para;</a></h2> <ul> <li>Add a neural controller for the <em>left_shoulder_forward_joint</em> joint of the Pi Robot and be able to make it move with it.<ul> <li>the neural network takes as input the desired position and the current position</li> <li>takes as output the effort command to send to the joint</li> <li>You can use Tensorflow to build and train the network (here, a <a href=http://www.theconstructsim.com/construct-learn-develop-robots-using-ros/robotigniteacademy_learnros/ros-courses-library/ros-deep-learning-with-tensor-flow-101-python/ ><strong>course on how to use Tensorflow with ROS</strong></a>).</li> <li>You can generate the training data from a PID controller</li> </ul> </li> <li>Send me your questions and results at <em><a href=mailto:rtellez@theconstructsim.com>&#114;&#116;&#101;&#108;&#108;&#101;&#122;&#64;&#116;&#104;&#101;&#99;&#111;&#110;&#115;&#116;&#114;&#117;&#99;&#116;&#115;&#105;&#109;&#46;&#99;&#111;&#109;</a></em></li> </ul> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../6-gazebo%20%E5%AE%98%E6%96%B9tutorials/Connect%20to%20ROS/4-Tutorial%20ROS%20Communication/ class="md-footer__link md-footer__link--prev" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 上一页 </span> 4 Tutorial ROS Communication </div> </div> </a> <a href=../55-Understanding%20the%20differences%20between%20robot_state_publisher%20and%20joint_state_publisher/ class="md-footer__link md-footer__link--next" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 下一页 </span> 55 Understanding the differences between robot state publisher and joint state publisher </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; mdeng li </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script> <script src=../../../assets/javascripts/bundle.7353b375.min.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> <script src=../../../javascripts/abcjs-plugin-min.js></script> </body> </html>